# Claude Code Discord Bot - Windows PowerShell Setup Script
# One-command setup for quick deployment
# Run: .\setup.ps1

$ErrorActionPreference = "Stop"

# Colors
function Write-ColorOutput($ForegroundColor) {
    $fc = $host.UI.RawUI.ForegroundColor
    $host.UI.RawUI.ForegroundColor = $ForegroundColor
    if ($args) {
        Write-Output $args
    }
    $host.UI.RawUI.ForegroundColor = $fc
}

Write-Host ""
Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Blue
Write-Host "â•‘           Claude Code Discord Bot - Setup                 â•‘" -ForegroundColor Blue
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Blue
Write-Host ""

# Function to check if command exists
function Test-Command($command) {
    try {
        Get-Command $command -ErrorAction Stop | Out-Null
        return $true
    } catch {
        return $false
    }
}

# Step 1: Check/Install Deno
Write-Host "[1/5] Checking Deno installation..." -ForegroundColor Yellow
if (Test-Command "deno") {
    $denoVersion = deno --version | Select-Object -First 1
    Write-Host "âœ“ Deno is installed: $denoVersion" -ForegroundColor Green
} else {
    Write-Host "Deno not found. Installing..." -ForegroundColor Yellow
    
    # Install Deno using PowerShell installer
    irm https://deno.land/install.ps1 | iex
    
    # Refresh PATH
    $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
    
    if (Test-Command "deno") {
        Write-Host "âœ“ Deno installed successfully" -ForegroundColor Green
    } else {
        Write-Host "âœ— Deno installation failed. Please install manually: https://deno.com" -ForegroundColor Red
        Write-Host "  After installing, restart PowerShell and run this script again." -ForegroundColor Yellow
        exit 1
    }
}

# Step 2: Check/Install Claude Code CLI
Write-Host "[2/5] Checking Claude Code CLI..." -ForegroundColor Yellow
if (Test-Command "claude") {
    Write-Host "âœ“ Claude CLI is installed" -ForegroundColor Green
} else {
    Write-Host "Claude CLI not found. Installing..." -ForegroundColor Yellow
    
    if (Test-Command "npm") {
        npm install -g @anthropic-ai/claude-code
        Write-Host "âœ“ Claude CLI installed" -ForegroundColor Green
        Write-Host "Run 'claude /login' to authenticate with Anthropic" -ForegroundColor Yellow
    } else {
        Write-Host "âœ— npm not found. Please install Node.js first: https://nodejs.org" -ForegroundColor Red
        exit 1
    }
}

# Step 3: Check for .env file or create one
Write-Host "[3/5] Checking environment configuration..." -ForegroundColor Yellow
$envFile = ".env"
if (Test-Path $envFile) {
    Write-Host "âœ“ .env file found" -ForegroundColor Green
} else {
    Write-Host "Creating .env file..." -ForegroundColor Yellow
    
    # Prompt for tokens
    Write-Host "Enter your Discord Bot Token:" -ForegroundColor Cyan
    $discordToken = Read-Host
    
    Write-Host "Enter your Discord Application ID:" -ForegroundColor Cyan
    $applicationId = Read-Host
    
    # Create .env file
    $envContent = @"
# Claude Code Discord Bot Configuration
# Generated by setup.ps1

# Required: Discord Bot Token (from Discord Developer Portal)
DISCORD_TOKEN=$discordToken

# Required: Discord Application ID (from Discord Developer Portal)
APPLICATION_ID=$applicationId

# Optional: Default working directory (defaults to current directory)
# WORK_DIR=C:\path\to\your\project

# Optional: User ID for mentions when Claude finishes
# USER_ID=your_discord_user_id

# Optional: Category name for organizing channels
# CATEGORY_NAME=claude-code
"@
    
    Set-Content -Path $envFile -Value $envContent
    Write-Host "âœ“ .env file created" -ForegroundColor Green
}

# Step 4: Initialize git if needed
Write-Host "[4/5] Checking git repository..." -ForegroundColor Yellow
if (Test-Path ".git") {
    Write-Host "âœ“ Git repository found" -ForegroundColor Green
} else {
    if (Test-Command "git") {
        Write-Host "Initializing git repository..." -ForegroundColor Yellow
        git init
        Write-Host "âœ“ Git repository initialized" -ForegroundColor Green
    } else {
        Write-Host "Git not installed. Skipping repository initialization." -ForegroundColor Yellow
    }
}

# Step 5: Verify setup
Write-Host "[5/5] Verifying setup..." -ForegroundColor Yellow
Write-Host "âœ“ All dependencies installed" -ForegroundColor Green

Write-Host ""
Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
Write-Host "â•‘                    Setup Complete! ğŸ‰                       â•‘" -ForegroundColor Green
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
Write-Host ""
Write-Host "To start the bot, run:" -ForegroundColor Cyan
Write-Host "  deno run --allow-all index.ts"
Write-Host ""
Write-Host "Or with hot reload (development):" -ForegroundColor Cyan
Write-Host "  deno run --allow-all --watch index.ts"
Write-Host ""
Write-Host "Or use the quick start command:" -ForegroundColor Cyan
Write-Host "  deno task start"
Write-Host ""

# Offer to start immediately
$startNow = Read-Host "Would you like to start the bot now? (y/n)"
if ($startNow -eq "y" -or $startNow -eq "Y") {
    Write-Host "Starting Claude Code Discord Bot..." -ForegroundColor Blue
    deno run --allow-all index.ts
}
